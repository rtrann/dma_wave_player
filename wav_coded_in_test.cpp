/*
 * Demonstrates sending a buffer repeatedly to the DAC using DMA.
 * Connect an oscilloscope to Mbed pin 18. This example doesn't
 * output anything else (nothing on any serial ports).
 */
#include "mbed.h"
#include "MODDMA.h"

// Make the buffer size match the number of degrees
// in a circle since we are going to output a sinewave.
#define BUFFER_SIZE 2880

// Set DAC output power mode.
#define DAC_POWER_MODE  (1 << 16)

DigitalOut led1(LED1);
DigitalOut led3(LED3);
DigitalOut led4(LED4);
    
AnalogOut signal(p18);

MODDMA dma;
MODDMA_Config *conf0, *conf1;

void TC0_callback(void);
void ERR0_callback(void);

void TC1_callback(void);
void ERR1_callback(void);

int main() {
    //printf("What uppp\r\n");
    volatile int life_counter = 0;
         
    int buffer[][BUFFER_SIZE] = {
    {32768, 32768, 32770, 32771, 32773, 32775, 32787, 32791, 32762, 32727,
32669, 32577, 32479, 32370, 32239, 32084, 31900, 31729, 31573, 31468,
31371, 31293, 31223, 31154, 31101, 31061, 31018, 31028, 31078, 31110,
31172, 31237, 31286, 31341, 31375, 31418, 31557, 31675, 31775, 31935,
32009, 31964, 31806, 30662, 25265, 23346, 27756, 30514, 30557, 31495,
32651, 33738, 34812, 36105, 37396, 38675, 40002, 41230, 42349, 43329,
44218, 45151, 45997, 46506, 47000, 47417, 47623, 47843, 47982, 48005,
47979, 47991, 47656, 47082, 46402, 45700, 45354, 44941, 44170, 43205,
42462, 41652, 40365, 39071, 38308, 38118, 38221, 37750, 36363, 34733,
33512, 32553, 31529, 30547, 30238, 30182, 29382, 27357, 25450, 24334,
23727, 23191, 22354, 22032, 22274, 23691, 27196, 30400, 28285, 24481,
25354, 27986, 28038, 28017, 27732, 22971, 17603, 16127, 15138, 13261,
11631, 10562, 9434, 8209, 7220, 6423, 5816, 5395, 4897, 4462,
4319, 4182, 4455, 5197, 6316, 7615, 8751, 9645, 10983, 12546,
13859, 15169, 16809, 18616, 20149, 21571, 23651, 26301, 28653, 30179,
31054, 32325, 34784, 37212, 38449, 38996, 40128, 41918, 44050, 45931,
47478, 48226, 49005, 50408, 52111, 53566, 53961, 54268, 55564, 56411,
55952, 56603, 57353, 57312, 57757, 59320, 60849, 60336, 59159, 59379,
60675, 62284, 63644, 63916, 63467, 62936, 63060, 64942, 64993, 64995,
65001, 64069, 62630, 62784, 62972, 61551, 61321, 61612, 58966, 57814,
59802, 60310, 59077, 58519, 58421, 58065, 57618, 57031, 56198, 55680,
55673, 53274, 51548, 51691, 51135, 49992, 47820, 44690, 42995, 42594,
43263, 45069, 44815, 40343, 36528, 35862, 34971, 33133, 31610, 28519,
25295, 23852, 22084, 21375, 21407, 20361, 20403, 21380, 20110, 18344,
14833, 11490, 13633, 15761, 10324, 6075, 7601, 8541, 7514, 6402,
5770, 5603, 5664, 7953, 10806, 12049, 10092, 8393, 5882, 5993,
6911, 3980, 3487, 4659, 1866, 611, 1272, 1678, 506, 118,
1612, 2996, 4499, 8148, 9701, 5323, 3337, 4483, 5193, 5998,
6083, 4410, 5321, 7790, 7440, 8257, 10318, 10405, 10516, 12604,
14393, 15625, 16370, 16711, 18072, 20159, 21539, 22044, 22252, 22552,
22818, 23413, 23430, 23116, 24498, 24888, 23191, 22950, 24836, 25745,
25245, 25888, 27318, 28521, 30628, 32766, 33534, 34078, 34854, 35500,
37132, 38402, 38740, 38932, 39258, 40330, 41345, 41908, 42670, 42987,
42625, 43242, 44659, 45556, 45638, 45550, 45543, 46405, 47927, 47999,
46743, 46445, 48104, 49692, 49896, 50246, 50627, 50971, 51860, 52785,
52707, 52989, 54039, 54293, 54151, 54918, 55875, 55966, 56135, 56325,
56204, 56332, 57034, 58018, 58653, 58867, 58426, 58247, 58706, 58653,
58578, 58915, 59432, 59172, 59279, 59118, 57993, 57726, 57710, 56600,
55983, 55984, 55602, 55393, 55112, 54771, 54624, 54519, 54204, 53766,
53496, 53359, 52854, 52100, 52112, 52714, 53256, 53416, 52846, 52555,
52106, 51281, 50399, 49480, 48826, 48656, 47992, 47897, 48339, 47380,
45868, 45135, 44695, 44240, 43252, 42316, 42647, 42780, 43105, 41889,
40261, 40872, 41234, 41065, 41628, 39716, 38377, 38099, 36749, 35794,
35657, 35465, 34448, 33214, 31531, 30496, 29922, 28195, 26719, 26920,
25884, 23520, 22731, 22815, 22298, 21900, 20779, 19246, 17857, 16560,
16027, 15088, 13479, 11950, 10666, 9578, 9254, 7414, 6122, 6568,
5896, 4432, 3740, 3886, 3691, 2703, 2675, 2857, 2510, 2322,
2576, 3785, 3505, 2750, 4332, 5741, 4414, 2820, 3541, 4263,
4213, 4444, 4515, 2668, 2319, 3863, 4325, 5414, 7911, 8693,
7954, 7134, 8246, 9783, 10398, 10676, 10919, 10948, 10534, 10289,
9868, 8542, 8940, 9932, 9326, 9297, 9425, 9534, 8632, 7998,
8344, 9518, 9788, 9780, 10043, 9798, 9693, 10168, 10593, 10710,
10924, 10514, 10520, 10123, 10219, 11145, 12021, 12558, 12666, 11776,
13043, 14408, 14115, 14058, 14237, 13869, 13906, 14659, 15036, 15414,
15345, 15806, 16754, 17510, 17832, 18254, 18803, 18779, 19810, 21269,
21484, 22329, 22958, 23313, 24404, 25784, 27030, 27740, 27939, 28760,
30445, 31371, 31985, 33427, 34843, 35151, 36043, 37020, 37710, 38868,
40092, 41264, 41781, 42810, 44620, 45768, 46456, 47469, 48649, 49688,
50300, 50771, 52155, 52633, 53098, 53860, 54017, 54597, 55424, 55586,
55742, 56844, 57564, 57974, 58234, 58536, 58807, 59361, 59573, 60838,
61651, 61311, 62026, 62560, 61759, 61867, 62401, 62722, 63094, 63567,
63992, 63977, 64913, 65461, 65460, 65458, 65199, 65399, 65454, 65452,
65450, 65446, 65441, 65438, 65437, 65437, 65435, 65430, 65299, 64891,
65423, 65422, 65370, 65418, 65415, 65414, 65413, 65412, 65234, 65413,
65413, 64231, 62689, 62054, 61546, 61190, 61324, 61046, 60520, 60275,
60950, 60520, 59300, 59620, 58947, 58719, 59236, 58470, 56427, 53626,
51648, 51653, 51315, 48926, 47293, 46938, 46498, 45646, 43723, 41786,
41007, 39953, 39742, 40094, 39433, 38117, 37270, 37189, 36563, 34616,
33609, 33026, 30938, 30143, 30459, 30252, 29576, 29150, 29213, 28388,
27324, 27306, 26994, 26232, 25186, 25326, 25992, 25490, 24744, 24224,
24271, 23843, 22662, 22035, 22159, 21841, 21361, 20864, 20761, 20505,
20128, 20357, 19385, 18244, 17750, 16407, 15220, 14666, 13609, 13588,
13378, 12700, 12134, 11992, 12045, 12269, 12174, 12212, 12203, 11208,
10933, 11520, 11078, 8901, 6674, 6087, 7318, 7372, 6652, 6613,
6481, 6374, 6011, 5436, 5234, 4727, 4118, 4219, 4295, 4296,
4113, 3500, 2863, 1934, 921, 496, 229, 21, 21, 21,
20, 21, 23, 22, 23, 24, 21, 17, 19, 21,
23, 24, 23, 24, 25, 26, 24, 26, 30, 29,
31, 32, 32, 34, 36, 37, 40, 41, 41, 43,
45, 43, 46, 46, 47, 46, 45, 47, 532, 1186,
1424, 1978, 2878, 3385, 3294, 4001, 5247, 5791, 6064, 6781,
7955, 9063, 10137, 11478, 12673, 14006, 14942, 14972, 15801, 16490,
16517, 16732, 16986, 17202, 18236, 18931, 19043, 19356, 20337, 21237,
21431, 22587, 23912, 24617, 26028, 27800, 28125, 28593, 29645, 30812,
31790, 32303, 33170, 33987, 35225, 36792, 36718, 36005, 36893, 38277,
39360, 39929, 40497, 40468, 40970, 42724, 43272, 42876, 43660, 45014,
46357, 46828, 47086, 47342, 47784, 48605, 49718, 51112, 52328, 53109,
53759, 54842, 55417, 55644, 55904, 56328, 57329, 58149, 57993, 57959,
58453, 58796, 58888, 59290, 60369, 61223, 60844, 61375, 62131, 62359,
63088, 63741, 63555, 63702, 63778, 63933, 64445, 64593, 64981, 65235,
65294, 65533, 65534, 65532, 65533, 65531, 65532, 65531, 65532, 65532,
65531, 65531, 65532, 65530, 65532, 65533, 65533, 65533, 65531, 65533,
65533, 65533, 65533, 65533, 65534, 65533, 65533, 65532, 65533, 65532,
65532, 65531, 65531, 65529, 65528, 65525, 65520, 65516, 65512, 65510,
65507, 65501, 65497, 65490, 65485, 65480, 65476, 65470, 65466, 65460,
65455, 65450, 65447, 65446, 65446, 65446, 65444, 65439, 65436, 65435,
65416, 64793, 64262, 63406, 62712, 62476, 62256, 61709, 61241, 60644,
60188, 59484, 59606, 59353, 58170, 57290, 57057, 56476, 55529, 54894,
54569, 54338, 54359, 53659, 52668, 52249, 51495, 50750, 50217, 49780,
48846, 47746, 46577, 45681, 45340, 44901, 43739, 42152, 41268, 40990,
39625, 38192, 38194, 37323, 35737, 34850, 34066, 33731, 33460, 32668,
31513, 30616, 29525, 28203, 27084, 26391, 25742, 25048, 24582, 23789,
22562, 21241, 20801, 20157, 19102, 17335, 16282, 15896, 15509, 14614,
13108, 12207, 11900, 10768, 9682, 9372, 9110, 8327, 7615, 7192,
6790, 6679, 6459, 6137, 5784, 5046, 4264, 4093, 3499, 2535,
2092, 1778, 1170, 619, 85, 53, 429, 624, 362, 5,
3, 2, 3, 3, 4, 4, 5, 3, 4, 3,
4, 6, 5, 3, 2, 5, 5, 4, 4, 7,
5, 4, 5, 1, 0, 1, 3, 4, 3, 2,
2, 3, 3, 1, 0, 2, 2, 2, 2, 3,
4, 3, 6, 10, 10, 13, 17, 21, 25, 30,
35, 40, 43, 48, 53, 62, 69, 75, 78, 83,
84, 88, 91, 94, 97, 102, 105, 106, 104, 104,
413, 832, 1380, 2151, 2863, 3648, 4292, 5108, 5885, 6540,
6734, 7244, 7993, 9001, 9836, 10562, 10872, 11316, 11691, 11717,
11931, 12793, 13516, 14231, 15089, 15764, 16540, 17088, 17615, 18401,
19097, 19732, 20552, 21352, 21953, 22822, 23735, 24504, 25566, 26412,
26857, 27461, 28344, 29137, 29944, 30811, 31393, 31828, 32448, 33375,
34361, 35136, 35833, 36168, 36609, 37343, 37989, 38521, 39346, 40343,
41491, 42061, 42703, 43485, 44189, 44808, 45643, 45995, 46521, 47297,
47946, 48883, 49578, 50086, 50541, 51166, 51926, 52923, 53944, 54634,
55229, 55893, 56559, 56949, 57806, 58791, 59413, 59674, 60126, 60789,
61223, 61432, 61638, 61608, 61642, 62022, 62255, 62517, 62919, 63031,
62997, 62718, 62523, 62733, 63085, 63377, 63302, 63263, 63459, 63832,
64027, 63973, 64334, 64630, 64849, 64840, 64877, 65069, 65205, 65464,
65507, 65509, 65509, 65411, 65509, 65509, 65505, 65507, 65506, 65491,
65507, 65508, 65311, 64902, 64566, 64404, 64197, 64258, 64340, 64191,
63899, 63357, 63143, 63396, 63363, 63109, 63013, 62840, 62844, 62600,
63022, 63503, 63571, 63594, 63505, 63368, 63415, 63409, 63291, 63483,
63824, 63702, 63262, 63373, 63661, 63386, 63244, 63221, 63113, 62953,
62899, 62744, 62861, 62879, 62655, 62419, 62107, 61708, 61321, 60931,
60624, 60216, 59769, 59634, 59389, 58974, 58317, 57673, 57143, 56823,
56366, 56138, 55823, 55391, 55003, 54720, 54288, 53675, 53087, 52520,
51981, 51555, 51159, 50527, 49877, 49438, 48792, 47757, 46896, 46492,
46207, 45610, 44941, 44637, 44092, 43145, 42389, 41918, 41353, 40693,
39952, 38911, 38188, 37477, 36610, 36030, 35774, 34923, 33646, 32960,
32494, 31740, 30885, 29986, 29549, 28764, 27682, 27079, 26775, 26090,
25303, 24878, 24280, 23788, 23417, 22652, 22134, 21814, 21005, 20277,
19949, 19485, 18960, 18114, 17244, 16750, 16312, 15662, 15171, 14787,
13990, 13369, 12875, 12431, 12154, 12062, 11917, 11898, 11740, 11620,
11605, 11466, 11443, 11388, 10727, 10231, 10348, 10010, 9538, 9306,
9021, 8550, 8184, 7965, 7953, 7705, 7345, 7230, 7074, 6851,
6573, 6082, 5825, 5614, 5241, 4799, 4729, 4663, 4325, 3883,
3617, 3492, 3247, 3080, 3074, 3067, 2732, 2650, 2643, 2639,
2081, 1536, 1186, 894, 709, 911, 863, 634, 904, 837,
637, 561, 298, 164, 497, 676, 598, 340, 169, 256,
241, 264, 256, 86, 12, 310, 450, 441, 663, 1108,
1312, 1477, 1436, 1365, 1790, 2011, 2024, 2051, 2448, 2642,
3101, 3431, 3724, 4027, 4235, 4496, 4914, 5106, 5368, 5593,
5764, 6388, 6868, 7182, 7301, 7481, 7984, 8517, 8823, 9206,
9504, 10049, 10641, 11053, 11293, 11775, 12423, 12905, 13515, 14206,
14798, 15335, 15873, 16167, 16619, 17186, 17675, 18152, 18954, 19678,
20238, 20827, 21511, 22220, 22866, 23454, 23990, 24857, 25944, 26926,
27761, 28616, 29386, 29987, 30780, 31762, 32625, 33360, 34124, 34992,
35792, 36474, 37323, 38264, 39078, 39654, 40219, 41019, 41896, 42753,
43589, 44347, 45253, 46097, 46900, 47670, 48620, 49666, 50447, 51120,
52096, 52953, 53401, 53968, 54611, 55021, 55535, 56099, 56727, 57433,
58099, 58642, 59061, 59521, 59845, 60065, 60441, 60926, 61417, 61790,
62056, 62377, 62623, 62927, 63178, 63374, 63553, 63591, 63759, 63967,
64228, 64251, 64341, 64644, 64981, 64992, 65082, 65240, 65300, 65160,
64724, 64565, 64893, 65208, 65294, 65417, 65529, 65284, 65108, 65295,
65329, 65108, 64953, 64888, 64609, 64458, 64281, 63827, 63314, 62910,
62741, 62690, 62663, 62475, 62089, 61634, 61360, 60967, 60337, 59664,
59412, 59128, 58517, 57969, 57755, 57411, 56754, 56070, 55385, 54735,
54267, 53653, 53094, 52716, 52087, 51557, 50931, 50289, 49625, 49028,
48412, 47815, 47356, 46659, 45988, 45440, 44828, 44061, 43339, 42778,
42281, 41676, 41123, 40461, 39811, 38902, 38172, 37632, 36994, 36399,
35627, 34692, 33762, 32957, 32163, 31529, 30986, 30309, 29632, 29116,
28661, 27909, 27250, 26724, 26155, 25438, 24726, 23976, 23437, 22819,
22062, 21151, 20349, 19948, 19659, 19077, 18494, 18057, 17588, 16981,
16499, 15903, 15246, 14682, 14188, 13690, 13013, 12386, 12010, 11731,
11303, 10699, 10108, 9706, 9209, 8647, 8383, 8161, 7895, 7537,
7049, 6446, 6214, 6142, 5875, 5492, 5249, 5166, 5009, 4857,
4690, 4568, 4306, 4203, 4245, 4226, 3938, 3726, 3800, 3871,
3966, 3892, 3598, 3540, 3702, 3935, 3994, 4150, 4493, 4660,
4924, 5182, 5419, 5748, 6075, 6332, 6797, 7180, 7603, 7928,
8147, 8344, 8722, 8902, 9305, 9853, 10110, 10490, 11103, 11601,
12032, 12530, 13068, 13384, 13964, 14594, 15098, 15616, 16114, 16550,
17035, 17483, 17999, 18720, 19375, 19730, 20171, 20714, 21307, 21943,
22579, 23120, 23778, 24527, 25237, 25714, 26167, 26684, 27266, 27812,
28255, 28855, 29533, 30091, 30623, 31203, 31638, 32137, 32723, 33371,
33818, 34180, 34596, 35193, 35854, 36238, 36389, 36867, 37478, 37942,
38318, 38694, 39090, 39453, 39886, 40388, 40739, 41100, 41543, 42073,
42556, 42762, 43041, 43372, 43653, 43973, 44338, 44491, 44794, 45222,
45449, 45636, 45935, 46282, 46620, 46833, 46901, 47136, 47679, 48124,
48332, 48516, 48653, 48749, 48934, 49200, 49422, 49586, 49661, 49731,
49927, 50066, 50245, 50381, 50305, 50286, 50413, 50585, 50581, 50323,
50137, 50223, 50266, 50271, 50173, 50075, 49851, 49655, 49635, 49507,
49226, 49005, 48860, 48717, 48579, 48418, 48161, 47826, 47441, 47024,
46704, 46578, 46425, 46122, 45940, 45556, 45265, 45102, 45060, 44958,
44631, 44231, 43855, 43553, 43223, 42961, 42702, 42489, 42260, 41929,
41692, 41334, 40828, 40300, 39801, 39306, 38981, 38817, 38596, 38193,
37760, 37406, 37129, 36786, 36529, 36283, 36021, 35646, 35311, 35155,
34978, 34718, 34458, 34208, 33802, 33358, 32953, 32590, 32270, 31987,
31630, 31249, 30950, 30671, 30320, 30037, 29814, 29436, 28999, 28716,
28277, 27894, 27739, 27575, 27323, 27023, 26755, 26485, 26170, 25922,
25812, 25603, 25305, 25105, 24993, 24833, 24559, 24328, 24192, 23985,
23771, 23640, 23483, 23308, 23169, 23091, 22964, 22797, 22798, 22793,
22683, 22583, 22492, 22331, 22292, 22234, 22044, 21917, 21963, 22006,
21893, 21732, 21645, 21673, 21761, 21964, 22226, 22398, 22431, 22487,
22766, 22998, 23103, 23292, 23515, 23696, 23867, 24055, 24110, 24231,
24465, 24632, 24775, 24966, 25206, 25419, 25607, 25873, 26091, 26275,
26531, 26821, 26996, 27129, 27346, 27622, 27758, 27900, 28173, 28464,
28679, 28950, 29183, 29366, 29492, 29663, 30021, 30318, 30569, 30954,
31210, 31365, 31643, 31871, 32025, 32250, 32563, 32801, 32968, 33192,
33462, 33766, 34110, 34335, 34475, 34622, 34757, 34851, 34945, 35169,
35360, 35480, 35573, 35743, 35957, 36135, 36360, 36599, 36788, 36851,
36894, 37106, 37408, 37691, 38029, 38270, 38408, 38517, 38658, 38707,
38769, 38835, 38911, 39071, 39221, 39410, 39588, 39676, 39633, 39566,
39611, 39734, 39875, 39878, 39970, 39977, 40004, 40153, 40355, 40582,
40727, 40781, 40795, 40860, 40920, 40958, 41059, 41169, 41157, 41146,
41267, 41378, 41372, 41380, 41335, 41248, 41156, 41271, 41422, 41409,
41308, 41216, 41221, 41245, 41158, 41071, 40960, 40817, 40775, 40764,
40655, 40468, 40286, 40222, 40172, 40107, 40038, 39892, 39635, 39354,
39243, 39252, 39131, 38979, 38816, 38672, 38566, 38459, 38316, 38238,
38153, 37957, 37804, 37662, 37540, 37471, 37394, 37184, 36966, 36793,
36695, 36554, 36360, 36144, 35990, 35839, 35717, 35633, 35502, 35239,
35022, 34935, 34734, 34482, 34272, 34125, 33927, 33610, 33326, 33091,
32915, 32719, 32495, 32247, 31997, 31712, 31517, 31312, 31031, 30794,
30607, 30426, 30144, 29773, 29446, 29211, 29008, 28769, 28457, 28198,
27951, 27762, 27559, 27247, 27032, 26873, 26690, 26463, 26249, 26015,
25821, 25596, 25309, 25102, 25015, 24812, 24607, 24394, 24192, 24071,
24016, 23834, 23555, 23386, 23282, 23180, 23115, 23055, 22911, 22817,
22687, 22528, 22407, 22295, 22193, 22098, 22011, 21963, 21998, 21921,
21873, 21784, 21581, 21548, 21684, 21811, 21830, 21750, 21720, 21773,
21920, 22121, 22166, 22179, 22280, 22349, 22379, 22483, 22603, 22639,
22718, 22838, 22992, 23115, 23226, 23361, 23575, 23731, 23833, 23920,
24070, 24145, 24349, 24531, 24733, 24947, 25181, 25340, 25432, 25542,
25711, 25958, 26193, 26406, 26600, 26757, 26960, 27145, 27330, 27498,
27726, 27952, 28128, 28198, 28340, 28634, 28849, 29131, 29358, 29548,
29778, 30001, 30177, 30345, 30485, 30686, 30944, 31111, 31299, 31534,
31697, 31857, 31983, 32098, 32301, 32609, 32852, 33073, 33261, 33447,
33655, 33874, 34076, 34240, 34428, 34567, 34694, 34841, 35042, 35250,
35443, 35576, 35738, 35915, 36051, 36207, 36392, 36513, 36605, 36753,
36961, 37143, 37307, 37450, 37532, 37695, 37877, 38004, 38117, 38261,
38377, 38480, 38589, 38733, 38908, 39022, 39079, 39135, 39264, 39399,
39482, 39544, 39639, 39696, 39718, 39751, 39801, 39842, 39886, 39983,
40084, 40116, 40116, 40158, 40205, 40254, 40304, 40324, 40334, 40388,
40362, 40317, 40298, 40297, 40284, 40274, 40325, 40405, 40420, 40426,
40430, 40397, 40348, 40278, 40213, 40189, 40190, 40159, 40101, 40065,
40020, 39933, 39846, 39794, 39753, 39683, 39599, 39550, 39492, 39380,
39289, 39238, 39189, 39124, 39024, 38909, 38810, 38724, 38612, 38519,
38401, 38301, 38232, 38175, 38115, 38039, 37879, 37706, 37601, 37506,
37365, 37259, 37182, 37085, 36957, 36839, 36727, 36606, 36474, 36299,
36129, 36014, 35919, 35830, 35699, 35569, 35461, 35336, 35184, 35054,
34920, 34745, 34578, 34470, 34362, 34227, 34085, 33938, 33738, 33580,
33487, 33402, 33286, 33148, 33003, 32893, 32796, 32658, 32548, 32445,
32325, 32189, 32082, 31986, 31899, 31808, 31722, 31603, 31499, 31399,
31303, 31209, 31092, 30991, 30885, 30794, 30713, 30627, 30551, 30482,
30389, 30289, 30201, 30124, 30069, 30009, 29946, 29869, 29811, 29755,
29680, 29624, 29586, 29510, 29444, 29371, 29303, 29252, 29210, 29166,
29120, 29082, 29039, 29019, 29011, 29021, 29001, 28966, 28931, 28931,
28929, 28911, 28911, 28911, 28928, 28927, 28930, 28939, 28956, 28972,
28991, 29001, 29021, 29031, 29045, 29070, 29114, 29144, 29194, 29226,
29264, 29317, 29356, 29378, 29439, 29484, 29543, 29597, 29659, 29710,
29757, 29802, 29853, 29918, 29973, 30015, 30081, 30149, 30211, 30265,
30325, 30394, 30449, 30523, 30583, 30643, 30715, 30778, 30841, 30897,
30954, 31008, 31081, 31149, 31213, 31269, 31323, 31394, 31455, 31512,
31568, 31615, 31674, 31731, 31793, 31847, 31896, 31949, 32001, 32049,
32102, 32147, 32188, 32234, 32283, 32323, 32363, 32411, 32454, 32494,
32534, 32573, 32611, 32644, 32681, 32708, 32740, 32758, 32772, 32796,
32816, 32833, 32861, 32874, 32900, 32911, 32925, 32939, 32950, 32964,
32976, 32986, 32993, 33002, 33012, 33023, 33034, 33042, 33048, 33057,
33065, 33067, 33077, 33083, 33086, 33092, 33104, 33114, 33117, 33125,
33124, 33130, 33133, 33138, 33142, 33141, 33152, 33157, 33163, 33169,
33177, 33170, 33177, 33174, 33176, 33174, 33183, 33186, 33188, 33194,
33196, 33197, 33200, 33203, 33199, 33201, 33205, 33210, 33208, 33208,
33209, 33214, 33211, 33212, 33214, 33213, 33214, 33210, 33211, 33212,
33212, 33211, 33211, 33212, 33212, 33211, 33209, 33209, 33205, 33211,
33199, 33202, 33203, 33198, 33200, 33192, 33187, 33187, 33183, 33176,
33175, 33176, 33172, 33168, 33164, 33157, 33153, 33152, 33152, 33147,
33139, 33135, 33133, 33127, 33126, 33126, 33121, 33114, 33109, 33105,
33103, 33100, 33094, 33093, 33083, 33087, 33082, 33075, 33069, 33065,
33061, 33056, 33053, 33054, 33046, 33041, 33036, 33034, 33024, 33025,
33022, 33017, 33012, 33012, 33002, 33000, 32995, 32992, 32988, 32980,
32980, 32973, 32972, 32968, 32962, 32962, 32955, 32952, 32948, 32947,
32943, 32937, 32937, 32933, 32933, 32923, 32921, 32917, 32912, 32903,
32903, 32903, 32898, 32897, 32894, 32885, 32886, 32887, 32879, 32880,
32879, 32879, 32875, 32876, 32874, 32866, 32864, 32860, 32860, 32855,
32851, 32857, 32847, 32846, 32843, 32842, 32835, 32835, 32831, 32829,
32827, 32817, 32819, 32819, 32817, 32814, 32809, 32806, 32805, 32803,
32803, 32801, 32801, 32797, 32797, 32795, 32794, 32793, 32790, 32790,
32788, 32787, 32787, 32785, 32785, 32787, 32785, 32783, 32780, 32782,
32780, 32779, 32778, 32780, 32779, 32778, 32777, 32777, 32775, 32774,
32773, 32774, 32773, 32773, 32773, 32771, 32772, 32773, 32771, 32770,
32771, 32772, 32771, 32769, 32769, 32768, 32769, 32769, 32769, 32768,
32769, 32769, 32768, 32769, 32769, 32769, 32768, 32769, 32768, 32768,
32769, 32769, 32768, 32768, 32768, 32768, 32768, 32768, 32768, 32768},
    {}
    };

    // Adjust the sinewave buffer for use with DAC hardware.
    for (int i = 0; i < BUFFER_SIZE; i++) {
        buffer[0][i] = DAC_POWER_MODE | ((buffer[0][i] << 6) & 0xFFC0);
        //printf("buffer 0 %d = %d\r\n", i, buffer[0][i]);
        buffer[1][i] = buffer[0][i]; // Just create a copy of buffer0 to continue sinewave.
    }

    // Prepare the GPDMA system for buffer0.
    conf0 = new MODDMA_Config;
    conf0
     ->channelNum    ( MODDMA::Channel_0 )
     ->srcMemAddr    ( (uint32_t) &buffer[0] )
     ->dstMemAddr    ( MODDMA::DAC )
     ->transferSize  ( BUFFER_SIZE * 2 ) //in bytes
     ->transferType  ( MODDMA::m2p )
     ->dstConn       ( MODDMA::DAC )
     ->transferWidth ( MODDMA::halfword )     
     ->attach_tc     ( &TC0_callback )
     ->attach_err    ( &ERR0_callback )     
    ; // config end
    
    
    // Prepare the GPDMA system for buffer1.
    conf1 = new MODDMA_Config;
    conf1
     ->channelNum    ( MODDMA::Channel_1 )
     ->srcMemAddr    ( (uint32_t) &buffer[1] )
     ->dstMemAddr    ( MODDMA::DAC )
     ->transferSize  ( BUFFER_SIZE *2) //in bytes
     ->transferType  ( MODDMA::m2p )
     ->dstConn       ( MODDMA::DAC )
     ->transferWidth ( MODDMA::halfword )
     ->attach_tc     ( &TC1_callback )
     ->attach_err    ( &ERR1_callback )     
    ; // config end

    LPC_DAC->DACCNTVAL =  7; // 6500 for 10Hz

    // Prepare first configuration.
    if (!dma.Prepare( conf0 )) {
        error("Doh!");
    }
    
    // Begin (enable DMA and counter). Note, don't enable
    // DBLBUF_ENA as we are using DMA double buffering.
    LPC_DAC->DACCTRL |= (3UL << 2); //CNT_ENA time out counter is enabled, DMA_ENA is enabled
    
    while (1) { 
        // There's not a lot to do as DMA and interrupts are
        // now handling the buffer transfers. So we'll just
        // flash led1 to show the Mbed is alive and kicking.
        if (life_counter++ > 1000000) {
            led1 = !led1; // Show some sort of life.
            life_counter = 0;
        }
    } 
}

// Configuration callback on TC
void TC0_callback(void) {
    
    // Just show sending buffer0 complete.
    led3 = !led3; 

    // Get configuration pointer.
    MODDMA_Config *config = dma.getConfig();
    
    // Finish the DMA cycle by shutting down the channel.
    dma.Disable( (MODDMA::CHANNELS)config->channelNum() );
   
    // Swap to buffer1
    dma.Prepare( conf1 ); //setup and enable

    // Clear DMA IRQ flags.
    if (dma.irqType() == MODDMA::TcIrq) dma.clearTcIrq(); 
}

// Configuration callback on Error
void ERR0_callback(void) {
    error("TC0 Callback error");
}

// Configuration callback on TC
void TC1_callback(void) {
    
    // Just show sending buffer1 complete.
    led4 = !led4; 
   
    // Get configuration pointer.
    MODDMA_Config *config = dma.getConfig();
    
    // Finish the DMA cycle by shutting down the channel.
    dma.Disable( (MODDMA::CHANNELS)config->channelNum() );
    
    // Swap to buffer0
    dma.Prepare( conf0 );
    
    // Clear DMA IRQ flags.
    if (dma.irqType() == MODDMA::TcIrq) dma.clearTcIrq(); 
}

// Configuration callback on Error
void ERR1_callback(void) {
    error("TC1 Callback error");
}

